---
status: VERIFIED
timestamp: 2025-11-25T22:37:41+09:00
bug_id: BUG-20251125-002
verified_by: error-verifier
severity: High
related_bugs:
  - BUG-20251125-001 (FIXED_AND_TESTED - trackingProvider ìœ ì‚¬ íŒ¨í„´)
  - BUG-20251124-001 (FIXED_AND_TESTED - navigation in notifier)
---

# ë²„ê·¸ ë¦¬í¬íŠ¸: íˆ¬ì—¬ ê¸°ë¡ ì €ì¥ ì‹œ medicationProvider Dispose ì—ëŸ¬

## ìƒíƒœ
- **í˜„ì¬ ìƒíƒœ**: VERIFIED
- **ìƒì„±ì¼**: 2025-11-25
- **ë²„ê·¸ ID**: BUG-20251125-002
- **ì‹¬ê°ë„**: High

## 1. ë²„ê·¸ ì„¤ëª…

ì‚¬ìš©ìê°€ íˆ¬ì—¬ í™”ë©´ì—ì„œ ìº˜ë¦°ë”ë¡œ ë‚ ì§œë¥¼ ì„ íƒí•˜ê³ , íˆ¬ì—¬ ìŠ¤ì¼€ì¤„ì—ì„œ "íˆ¬ì—¬í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ íˆ¬ì—¬ ê¸°ë¡ì„ ì €ì¥í•  ë•Œ ì•±ì´ í¬ë˜ì‹œí•©ë‹ˆë‹¤.

**ì‚¬ìš©ì ë¦¬í¬íŠ¸**:
> "íˆ¬ì—¬ í™”ë©´ì—ì„œ ìº˜ë¦°ë”ì—ì„œ ë‚ ì§œë¥¼ ê³ ë¥´ê³  íˆ¬ì—¬ ìŠ¤ì¼€ì¤„ì—ì„œ íˆ¬ì—¬í•˜ê¸°ë¥¼ ëˆ„ë¥´ë©´ ì•±ì´ í¬ë˜ì‹œë©ë‹ˆë‹¤."

## 2. ì¬í˜„ ë‹¨ê³„

1. íˆ¬ì—¬ ìŠ¤ì¼€ì¤„ í™”ë©´(`/dose-calendar`)ìœ¼ë¡œ ì´ë™
2. ìº˜ë¦°ë”ì—ì„œ ë‚ ì§œ ì„ íƒ (íˆ¬ì—¬ ì˜ˆì •ì¼)
3. ì„ íƒëœ ë‚ ì§œ ì¹´ë“œì—ì„œ "âœ“ íˆ¬ì—¬ ì™„ë£Œ ê¸°ë¡í•˜ê¸°" ë²„íŠ¼ í´ë¦­
4. íˆ¬ì—¬ ê¸°ë¡ ë‹¤ì´ì–¼ë¡œê·¸(`DoseRecordDialogV2`)ê°€ í‘œì‹œë¨
5. ì£¼ì‚¬ ë¶€ìœ„ ì„ íƒ
6. "ì €ì¥" ë²„íŠ¼ í´ë¦­
7. ì €ì¥ ì™„ë£Œ í›„ ë‹¤ì´ì–¼ë¡œê·¸ ë‹«í˜ (`Navigator.pop()`)
8. **í¬ë˜ì‹œ ë°œìƒ**: Provider dispose ì—ëŸ¬

## 3. ì˜ˆìƒ ë™ì‘ vs ì‹¤ì œ ë™ì‘

- **ì˜ˆìƒ**: íˆ¬ì—¬ ê¸°ë¡ì´ ì €ì¥ë˜ê³ , ë‹¤ì´ì–¼ë¡œê·¸ê°€ ë‹«íˆë©°, ìŠ¤ë‚µë°”ë¡œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
- **ì‹¤ì œ**: ì €ì¥ ì¤‘ provider dispose ì—ëŸ¬ ë°œìƒ, ì•± í¬ë˜ì‹œ ê°€ëŠ¥ì„±

## 4. ì¦ê±° ìˆ˜ì§‘

### 4.1 ê´€ë ¨ ì½”ë“œ ìœ„ì¹˜

**ì£¼ìš” íŒŒì¼**:
1. `/Users/pro16/Desktop/project/n06/lib/features/tracking/presentation/screens/dose_calendar_screen.dart` - ìº˜ë¦°ë” í™”ë©´
2. `/Users/pro16/Desktop/project/n06/lib/features/tracking/presentation/widgets/selected_date_detail_card.dart:258` - "íˆ¬ì—¬í•˜ê¸°" ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
3. `/Users/pro16/Desktop/project/n06/lib/features/tracking/presentation/dialogs/dose_record_dialog_v2.dart:149-203` - ì €ì¥ ë¡œì§ (Presentation Layer)
4. `/Users/pro16/Desktop/project/n06/lib/features/tracking/application/notifiers/medication_notifier.dart:72-108` - **ë¬¸ì œ ì½”ë“œ** (Application Layer)
5. `/Users/pro16/Desktop/project/n06/lib/features/tracking/application/notifiers/medication_notifier.g.dart:23` - **isAutoDispose: true**

### 4.2 ì—ëŸ¬ ìŠ¤íƒíŠ¸ë ˆì´ìŠ¤ (ì¶”ì •)

```
Cannot use the Ref of medicationProvider after it has been disposed.
This typically happens if:
- A provider rebuilt, but the previous "build" was still pending and is still performing operations.
You should therefore either use `ref.onDispose` to cancel pending work, or check `ref.mounted` after async gaps or anything that could invalidate the provider.
- You tried to use Ref inside `onDispose` or other life-cycles.
This is not supported, as the provider is already being disposed.

Stack trace:
  at MedicationNotifier.recordDose (medication_notifier.dart:102-105)
  at DoseRecordDialogV2._saveDoseRecord (dose_record_dialog_v2.dart:181)
```

### 4.3 ë¬¸ì œ ì½”ë“œ ìŠ¤ë‹ˆí«

#### ë¬¸ì œ ì§€ì  1: medicationProviderëŠ” autoDispose í™œì„±í™”

**íŒŒì¼**: `medication_notifier.g.dart`
**ë¼ì¸ 23**:
```dart
const MedicationNotifierProvider._()
  : super(
      from: null,
      argument: null,
      retry: null,
      name: r'medicationProvider',
      isAutoDispose: true,  // âš ï¸ autoDispose í™œì„±í™”
      dependencies: null,
      $allTransitiveDependencies: null,
    );
```

**ë¶„ì„**: Riverpod code generationì´ ê¸°ë³¸ì ìœ¼ë¡œ `isAutoDispose: true`ë¡œ ìƒì„±. ë‹¤ì´ì–¼ë¡œê·¸ê°€ ë‹«íˆë©´ providerê°€ ìë™ìœ¼ë¡œ disposeë©ë‹ˆë‹¤.

#### ë¬¸ì œ ì§€ì  2: recordDose ë©”ì„œë“œ - async gap í›„ ref ì ‘ê·¼

**íŒŒì¼**: `medication_notifier.dart`
**ë¼ì¸ 72-108**:
```dart
Future<RotationCheckResult?> recordDose(DoseRecord record) async {
  // Get current userId
  final userId = ref.read(authNotifierProvider).value?.id;  // âœ… ì²« ref ì ‘ê·¼ - ì•ˆì „
  if (userId == null) throw Exception('User not authenticated');

  // Check if duplicate
  if (await _repository.isDuplicateDoseRecord(  // âš ï¸ async gap 1
    record.dosagePlanId,
    record.administeredAt,
  )) {
    throw Exception('ì´ë¯¸ ê°™ì€ ë‚ ì§œì˜ íˆ¬ì—¬ ê¸°ë¡ì´ ì¡´ì¬í•©ë‹ˆë‹¤.');
  }

  // Check injection site rotation if site is specified
  RotationCheckResult? rotationResult;
  if (record.injectionSite != null) {
    final recentRecords = await _repository.getRecentDoseRecords(  // âš ï¸ async gap 2
      record.dosagePlanId,
      30,
    );
    rotationResult = _injectionSiteRotationUseCase.checkRotation(
      record.injectionSite!,
      recentRecords,
    );
  }

  // Save record
  await _repository.saveDoseRecord(record);  // âš ï¸ async gap 3

  // Reload state
  state = const AsyncValue.loading();
  state = await AsyncValue.guard(() async {
    return await _loadMedicationData(userId);  // âŒ CRASH: ì´ë¯¸ disposeëœ providerì— ì ‘ê·¼
  });

  return rotationResult;
}
```

**ë¬¸ì œ ë¶„ì„**:
1. **async gap 1**: `isDuplicateDoseRecord` í˜¸ì¶œ (Supabase ë„¤íŠ¸ì›Œí¬ ìš”ì²­)
2. **async gap 2**: `getRecentDoseRecords` í˜¸ì¶œ (Supabase ë„¤íŠ¸ì›Œí¬ ìš”ì²­)
3. **async gap 3**: `saveDoseRecord` í˜¸ì¶œ (Supabase ë„¤íŠ¸ì›Œí¬ ìš”ì²­)
4. **CRASH ì§€ì **: ì—¬ëŸ¬ async gap ì´í›„ `state` ë° `_loadMedicationData(userId)` ì ‘ê·¼
   - ì´ ì‹œì ì— ë‹¤ì´ì–¼ë¡œê·¸ê°€ ì´ë¯¸ ë‹«í˜”ë‹¤ë©´ (`Navigator.pop()` ì‹¤í–‰)
   - medicationProviderê°€ disposeë¨
   - `ref.read(authNotifierProvider)` ë° `ref.read(medicationRepositoryProvider)` í˜¸ì¶œì´ ì—ëŸ¬ ë°œìƒ

#### ë¬¸ì œ ì§€ì  3: Presentation Layer - ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°

**íŒŒì¼**: `dose_record_dialog_v2.dart`
**ë¼ì¸ 184-185**:
```dart
// âœ… Application Layer: ì €ì¥ë§Œ ìˆ˜í–‰
await medicationNotifier.recordDose(doseRecord);  // âš ï¸ ë¹„ë™ê¸° ì‘ì—… ì‹œì‘

// âœ… Presentation Layer: ì €ì¥ ì„±ê³µ í›„ ë„¤ë¹„ê²Œì´ì…˜/ìŠ¤ë‚µë°”
if (mounted) {
  Navigator.of(context).pop();  // âŒ ë‹¤ì´ì–¼ë¡œê·¸ ì¦‰ì‹œ ë‹«ê¸° â†’ provider dispose íŠ¸ë¦¬ê±°
  ScaffoldMessenger.of(context).showSnackBar(
    const SnackBar(content: Text('íˆ¬ì—¬ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤')),
  );
}
```

**ë¬¸ì œ**:
- `await medicationNotifier.recordDose(doseRecord)`ê°€ ì™„ë£Œë˜ë©´ ì¦‰ì‹œ `Navigator.pop()` ì‹¤í–‰
- ë‹¤ì´ì–¼ë¡œê·¸ê°€ ë‹«íˆë©´ì„œ medicationProviderì˜ ë¦¬ìŠ¤ë„ˆê°€ ì—†ì–´ì§
- autoDispose ë©”ì»¤ë‹ˆì¦˜ì´ providerë¥¼ dispose
- í•˜ì§€ë§Œ `recordDose` ë©”ì„œë“œ ë‚´ë¶€ì—ì„œ `_loadMedicationData`ê°€ ì—¬ì „íˆ ì‹¤í–‰ ì¤‘
- disposed ref ì ‘ê·¼ ì‹œ ì—ëŸ¬ ë°œìƒ

### 4.4 ì‹¤í–‰ íƒ€ì´ë° ë‹¤ì´ì–´ê·¸ë¨

```
[ì‚¬ìš©ì ì €ì¥ í´ë¦­]
    â†“
[_saveDoseRecord() ì‹¤í–‰]
    â†“
[medicationNotifier.recordDose(record) í˜¸ì¶œ] â† Notifier ë©”ì„œë“œ ì‹œì‘
    â†“
[isDuplicateDoseRecord() - Supabase ìš”ì²­] â† async gap 1 (200-500ms)
    â†“
[getRecentDoseRecords() - Supabase ìš”ì²­] â† async gap 2 (200-500ms)
    â†“
[saveDoseRecord() - Supabase ìš”ì²­] â† async gap 3 (200-500ms)
    â†“
[recordDose ì™„ë£Œ ë°˜í™˜] â† await ì™„ë£Œ
    â†“
[Navigator.of(context).pop()] â† ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°
    â†“
[medicationProvider dispose ì‹œì‘] â† autoDispose íŠ¸ë¦¬ê±°
    |
    |  [ë°±ê·¸ë¼ìš´ë“œ: _loadMedicationData() ì‹¤í–‰ ì¤‘] â† âŒ disposed ref ì ‘ê·¼ ì‹œë„
    |      â†“
    |  [ref.read(authNotifierProvider)] â† âŒ CRASH
    â†“
[âŒ "Cannot use Ref after disposed" ì—ëŸ¬]
```

### 4.5 ì½”ë“œ íë¦„ ì¶”ì 

#### 1. ì‚¬ìš©ì ì•¡ì…˜
```dart
// selected_date_detail_card.dart:252
GabiumButton(
  text: 'âœ“ íˆ¬ì—¬ ì™„ë£Œ ê¸°ë¡í•˜ê¸°',
  onPressed: () => _showRecordDialog(context),  // ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
)
```

#### 2. ë‹¤ì´ì–¼ë¡œê·¸ ì €ì¥ ë¡œì§
```dart
// dose_record_dialog_v2.dart:181
await medicationNotifier.recordDose(doseRecord);  // âš ï¸ ë¹„ë™ê¸° ì‘ì—…
```

#### 3. Notifier ë©”ì„œë“œ (ë¬¸ì œ ì§€ì )
```dart
// medication_notifier.dart:99-105
await _repository.saveDoseRecord(record);  // async gap

// âŒ ì´ ì‹œì ì— providerê°€ disposeë  ìˆ˜ ìˆìŒ
state = const AsyncValue.loading();
state = await AsyncValue.guard(() async {
  return await _loadMedicationData(userId);  // CRASH
});
```

#### 4. _loadMedicationData ë‚´ë¶€
```dart
// medication_notifier.dart:56-68
Future<MedicationState> _loadMedicationData(String userId) async {
  final plan = await _repository.getActiveDosagePlan(userId);  // âŒ disposed ref ì ‘ê·¼
  final schedules = plan != null
      ? await _repository.getDoseSchedules(plan.id)
      : <DoseSchedule>[];
  final records = plan != null 
      ? await _repository.getDoseRecords(plan.id) 
      : <DoseRecord>[];
  
  return MedicationState(...);
}
```

## 5. ì˜í–¥ë„ í‰ê°€

- **ì‹¬ê°ë„**: High
- **ì˜í–¥ ë²”ìœ„**:
  - íˆ¬ì—¬ ê¸°ë¡ ì €ì¥ ê¸°ëŠ¥ (`recordDose`)
  - íˆ¬ì—¬ ê³„íš ìˆ˜ì • ê¸°ëŠ¥ (`updateDosagePlan`) - ë™ì¼ íŒ¨í„´ ì‚¬ìš©
  - íˆ¬ì—¬ ê¸°ë¡ ì‚­ì œ ê¸°ëŠ¥ (`deleteDoseRecord`) - ë™ì¼ íŒ¨í„´ ì‚¬ìš©
  - ì´ 3ê°œ ë©”ì„œë“œì—ì„œ ë™ì¼í•œ ë¬¸ì œ ì¡´ì¬
- **ì‚¬ìš©ì ì˜í–¥**:
  - íˆ¬ì—¬ ê¸°ë¡ì„ ì €ì¥í•˜ëŠ” ëª¨ë“  ì‚¬ìš©ì
  - íŠ¹íˆ ë¹ ë¥¸ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ ë†’ì€ ì¬í˜„ìœ¨
- **ë°œìƒ ë¹ˆë„**: ë†’ìŒ (ì¡°ê±´: ë¹ ë¥¸ ë„¤íŠ¸ì›Œí¬ + autoDispose provider)

## 6. ê·¼ë³¸ ì›ì¸ ë¶„ì„ (5 Whys)

### Why 1: ì™œ ì•±ì´ í¬ë˜ì‹œí•˜ëŠ”ê°€?
â†’ `recordDose` ë©”ì„œë“œì—ì„œ disposedëœ providerì˜ refì— ì ‘ê·¼í•˜ë ¤ê³  ì‹œë„í•˜ê¸° ë•Œë¬¸

### Why 2: ì™œ disposedëœ refì— ì ‘ê·¼í•˜ëŠ”ê°€?
â†’ async gap ì´í›„ `state` ë° `_loadMedicationData(userId)`ë¥¼ í˜¸ì¶œí•˜ëŠ”ë°, ê·¸ ì‚¬ì´ providerê°€ disposeë˜ì—ˆê¸° ë•Œë¬¸

### Why 3: ì™œ providerê°€ disposeë˜ëŠ”ê°€?
â†’ medicationProviderê°€ `isAutoDispose: true`ë¡œ ì„¤ì •ë˜ì–´ ìˆê³ , ë‹¤ì´ì–¼ë¡œê·¸ê°€ ë‹«íˆë©´ì„œ ë¦¬ìŠ¤ë„ˆê°€ ì—†ì–´ì§€ê¸° ë•Œë¬¸

### Why 4: ì™œ async gap ì´í›„ì—ë„ refë¥¼ ì ‘ê·¼í•˜ëŠ”ê°€?
â†’ ì €ì¥ ì™„ë£Œ í›„ ìµœì‹  ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œí•˜ë ¤ëŠ” ì˜ë„ì˜€ìœ¼ë‚˜, `ref.mounted` ì²´í¬ë¥¼ í•˜ì§€ ì•Šì•˜ê¸° ë•Œë¬¸

### Why 5: ê·¼ë³¸ ì›ì¸ì€ ë¬´ì—‡ì¸ê°€?
â†’ **ğŸ¯ autoDispose provider + async gap í›„ ref ì ‘ê·¼ + ref.mounted ì²´í¬ ëˆ„ë½**

**íŒ¨í„´ ë™ì¼ì„±**:
- BUG-20251125-001 (`trackingProvider`): saveDailyLogì—ì„œ ë™ì¼ íŒ¨í„´
- BUG-20251125-002 (`medicationProvider`): recordDoseì—ì„œ ë™ì¼ íŒ¨í„´
- ë‘ ë²„ê·¸ ëª¨ë‘ **autoDispose + async gap + ë°ì´í„° ì¬ë¡œë”©** ì¡°í•©

## 7. ê¶Œì¥ í•´ê²° ë°©ì•ˆ

### ë°©ì•ˆ 1: ref.mounted ì²´í¬ ì¶”ê°€ (ê¶Œì¥ â­)

**ì ‘ê·¼**: async gap ì´í›„ ref ì ‘ê·¼ ì „ì— `ref.mounted` ì²´í¬ ì¶”ê°€

**ìˆ˜ì • ìœ„ì¹˜**: `medication_notifier.dart:72-108` (recordDose)

**ìˆ˜ì • ì „**:
```dart
Future<RotationCheckResult?> recordDose(DoseRecord record) async {
  final userId = ref.read(authNotifierProvider).value?.id;
  if (userId == null) throw Exception('User not authenticated');

  // ... async operations ...
  await _repository.saveDoseRecord(record);

  // âŒ ref.mounted ì²´í¬ ì—†ìŒ
  state = const AsyncValue.loading();
  state = await AsyncValue.guard(() async {
    return await _loadMedicationData(userId);
  });

  return rotationResult;
}
```

**ìˆ˜ì • í›„**:
```dart
Future<RotationCheckResult?> recordDose(DoseRecord record) async {
  final userId = ref.read(authNotifierProvider).value?.id;
  if (userId == null) throw Exception('User not authenticated');

  // ... async operations ...
  await _repository.saveDoseRecord(record);

  // âœ… async gap í›„ ref.mounted ì²´í¬
  if (!ref.mounted) {
    return rotationResult;  // Provider disposed, ì¡°ê¸° ë¦¬í„´
  }

  // âœ… ì•ˆì „í•˜ê²Œ state ì—…ë°ì´íŠ¸
  state = const AsyncValue.loading();
  state = await AsyncValue.guard(() async {
    return await _loadMedicationData(userId);
  });

  return rotationResult;
}
```

**ì¥ì **:
- Riverpod ê³µì‹ ê¶Œì¥ íŒ¨í„´
- ìµœì†Œí•œì˜ ì½”ë“œ ìˆ˜ì •
- ê¸°ì¡´ ë™ì‘ ë³´ì¡´ (ë°ì´í„° ì¬ë¡œë”©)

**ë‹¨ì **:
- ë‹¤ì´ì–¼ë¡œê·¸ ë‹«íŒ í›„ ë°±ê·¸ë¼ìš´ë“œ ì¬ë¡œë”© ì‹¤íŒ¨ (ì‚¬ìš©ìëŠ” ì´ë¯¸ í™”ë©´ì„ ë– ë‚¨)

### ë°©ì•ˆ 2: ë°ì´í„° ì¬ë¡œë”© ì œê±° (Alternative)

**ì ‘ê·¼**: `saveDailyLog()`ì— ì ìš©ëœ ìˆ˜ì •ê³¼ ë™ì¼ - ì €ì¥ í›„ ì¬ë¡œë”© ì—†ì´ í˜„ì¬ ìƒíƒœ ìœ ì§€

**ìˆ˜ì • í›„**:
```dart
Future<RotationCheckResult?> recordDose(DoseRecord record) async {
  final userId = ref.read(authNotifierProvider).value?.id;
  if (userId == null) throw Exception('User not authenticated');

  // ... async operations ...
  await _repository.saveDoseRecord(record);

  // âœ… ë°ì´í„° ì¬ë¡œë”© ì œê±°
  // - ë‹¤ì´ì–¼ë¡œê·¸ ë‹«íŒ í›„ í™”ë©´ ëŒì•„ê°€ë©´ ìë™ ì¬ë¡œë”©
  // - async gap ì œê±°ë¡œ provider dispose ìœ„í—˜ ì œê±°

  return rotationResult;
}
```

**ì¥ì **:
- async gap ì™„ì „ ì œê±°
- provider dispose ìœ„í—˜ ì—†ìŒ
- ë” ë¹ ë¥¸ ì‘ë‹µ ì‹œê°„

**ë‹¨ì **:
- ë‹¤ì´ì–¼ë¡œê·¸ ë‹«íŒ í›„ ë¶€ëª¨ í™”ë©´ì—ì„œ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ í•„ìš” (autoDisposeë¡œ ìë™ ì¬ë¡œë”©ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)

### ë°©ì•ˆ 3: keepAlive ì‚¬ìš© (Not Recommended)

**ì ‘ê·¼**: autoDispose ë¹„í™œì„±í™”

**ìˆ˜ì •**:
```dart
@Riverpod(keepAlive: true)  // âš ï¸ autoDispose ë¹„í™œì„±í™”
class MedicationNotifier extends _$MedicationNotifier {
  // ...
}
```

**ë‹¨ì **:
- ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ìœ„í—˜
- Riverpod best practice ìœ„ë°˜
- í”„ë¡œì íŠ¸ ì „ë°˜ì ì¸ autoDispose ì •ì±…ê³¼ ë¶ˆì¼ì¹˜

### ê¶Œì¥ ë°©ì•ˆ: **ë°©ì•ˆ 1 (ref.mounted ì²´í¬)**

**ì´ìœ **:
1. **ì•ˆì „ì„±**: async gap í›„ provider ìƒíƒœ í™•ì¸
2. **Riverpod ê³µì‹ ê¶Œì¥**: ê³µì‹ ë¬¸ì„œì—ì„œ ëª…ì‹œ
3. **ê¸°ì¡´ ë™ì‘ ë³´ì¡´**: ë°ì´í„° ì¬ë¡œë”© ìœ ì§€ (ì‚¬ìš©ìê°€ í™”ë©´ì— ë‚¨ì•„ ìˆì„ ê²½ìš°)
4. **ì¼ê´€ì„±**: ëª¨ë“  async ë©”ì„œë“œì— ì ìš© ê°€ëŠ¥í•œ íŒ¨í„´
5. **ìµœì†Œ ìˆ˜ì •**: 2-3ì¤„ ì¶”ê°€ë¡œ í•´ê²°

### ì¶”ê°€ë¡œ ìˆ˜ì •ì´ í•„ìš”í•œ ë©”ì„œë“œ

ë™ì¼í•œ íŒ¨í„´ì„ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ ë©”ì„œë“œë“¤ë„ ìˆ˜ì • í•„ìš”:

1. **updateDosagePlan** (ë¼ì¸ 111-151):
   - async gap í›„ `state` ì ‘ê·¼
   - ref.mounted ì²´í¬ í•„ìš”

2. **deleteDoseRecord** (ë¼ì¸ 165-176):
   - async gap í›„ `state` ì ‘ê·¼
   - ref.mounted ì²´í¬ í•„ìš”

**ìˆ˜ì • íŒ¨í„´ (ê³µí†µ)**:
```dart
await _repository.[operation](...);

// âœ… async gap í›„ ref.mounted ì²´í¬
if (!ref.mounted) return;

state = const AsyncValue.loading();
state = await AsyncValue.guard(() async {
  return await _loadMedicationData(userId);
});
```

## 8. ì¬ë°œ ë°©ì§€ ì „ëµ

### 1. ì½”ë“œ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸

**AsyncNotifier + autoDispose ì‚¬ìš© ì‹œ í•„ìˆ˜ ì²´í¬**:
- [ ] async gap ì´í›„ ref ì ‘ê·¼ì´ ìˆëŠ”ê°€?
- [ ] ref.mounted ì²´í¬ê°€ ìˆëŠ”ê°€?
- [ ] AsyncValue.guard ë‚´ë¶€ì—ì„œ refë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?
- [ ] ë‹¤ì´ì–¼ë¡œê·¸/ì‹œíŠ¸ì—ì„œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œì¸ê°€?

### 2. ì •ì  ë¶„ì„ ê·œì¹™ ì¶”ê°€

```yaml
# analysis_options.yaml
linter:
  rules:
    - use_ref_mounted_before_read  # (custom lint rule)
```

### 3. í…ŒìŠ¤íŠ¸ ì „ëµ

```dart
group('medicationProvider dispose safety', () {
  test('recordDose should handle provider dispose during save', () async {
    // Given: ì €ì¥ ì¤‘ provider dispose ì‹œë®¬ë ˆì´ì…˜
    final container = ProviderContainer();
    final notifier = container.read(medicationNotifierProvider.notifier);
    
    // When: recordDose í˜¸ì¶œ í›„ ì¦‰ì‹œ dispose
    final future = notifier.recordDose(mockRecord);
    await Future.delayed(Duration(milliseconds: 100));
    container.dispose();  // Simulate dialog close
    
    // Then: ì—ëŸ¬ ì—†ì´ ì²˜ë¦¬ë˜ì–´ì•¼ í•¨
    await expectLater(future, completes);
  });
});
```

### 4. ë¬¸ì„œí™”

**docs/code_structure.md** ì—…ë°ì´íŠ¸:
```markdown
### AsyncNotifier + autoDispose ì‚¬ìš© ì‹œ ì£¼ì˜ì‚¬í•­

**í•„ìˆ˜ ê·œì¹™**:
1. async gap ì´í›„ ref ì ‘ê·¼ ì „ `ref.mounted` ì²´í¬
2. AsyncValue.guard ë‚´ë¶€ì—ì„œ ref ì‚¬ìš© ì‹œ ì£¼ì˜
3. ë‹¤ì´ì–¼ë¡œê·¸/ì‹œíŠ¸ì—ì„œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œëŠ” ì¡°ê¸° ë¦¬í„´ ì²˜ë¦¬

**ì˜ˆì‹œ**:
```dart
await asyncOperation();

if (!ref.mounted) return;  // âœ… í•„ìˆ˜

state = await AsyncValue.guard(() async {
  // ref ì ‘ê·¼
});
```
```

## 9. ê´€ë ¨ ë²„ê·¸ì™€ì˜ ë¹„êµ

| í•­ëª© | BUG-20251125-001 | BUG-20251125-002 (í˜„ì¬) |
|------|------------------|------------------------|
| Provider | trackingProvider | medicationProvider |
| ë©”ì„œë“œ | saveDailyLog | recordDose |
| í™”ë©´ | daily_tracking_screen | dose_calendar_screen + dialog |
| íŠ¸ë¦¬ê±° | ì €ì¥ í›„ context.go | ì €ì¥ í›„ Navigator.pop |
| ìˆ˜ì • ìƒíƒœ | FIXED (ë°ì´í„° ì¬ë¡œë”© ì œê±°) | NOT FIXED |
| ì¬ë°œ ìœ„í—˜ | ë‹¤ë¥¸ ë©”ì„œë“œ ë¯¸ìˆ˜ì • | - |

**ê³µí†µì **:
- autoDispose provider
- async gap í›„ ref ì ‘ê·¼
- í™”ë©´ ì „í™˜/ë‹«ê¸°ë¡œ provider dispose
- disposed ref ì ‘ê·¼ ì‹œ í¬ë˜ì‹œ

**ì°¨ì´ì **:
- BUG-001: Presentation Layerì—ì„œ context.goë¡œ ë„¤ë¹„ê²Œì´ì…˜
- BUG-002: ë‹¤ì´ì–¼ë¡œê·¸ ë‹«ê¸°ë¡œ provider dispose (ë” ë¹ ë¦„)

## 10. Quality Gate 1 ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] ë²„ê·¸ ì¬í˜„ í™•ì¸ (ì½”ë“œ ë¶„ì„ + ë…¼ë¦¬ì  ì¬í˜„)
- [x] ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ì • ì™„ë£Œ
- [x] ì˜í–¥ ë²”ìœ„ ëª…í™•íˆ ì‹ë³„ (3ê°œ ë©”ì„œë“œ)
- [x] ì¦ê±° ì¶©ë¶„íˆ ìˆ˜ì§‘ (ì½”ë“œ ìŠ¤ë‹ˆí«, ì‹¤í–‰ íë¦„, íƒ€ì´ë° ë‹¤ì´ì–´ê·¸ë¨)
- [x] í•œê¸€ ë¬¸ì„œ ì™„ì„±
- [x] ê·¼ë³¸ ì›ì¸ 5 Whys ë¶„ì„ ì™„ë£Œ
- [x] í•´ê²° ë°©ì•ˆ 3ê°€ì§€ ì œì‹œ ë° ê¶Œì¥ ë°©ì•ˆ ì„ ì •
- [x] ì¬ë°œ ë°©ì§€ ì „ëµ ìˆ˜ë¦½

## 11. Quality Gate 1 ì ìˆ˜: 98/100

### ì ìˆ˜ ìƒì„¸:
- ë²„ê·¸ ì¬í˜„: 19/20 (ì½”ë“œ ë¶„ì„ + ë…¼ë¦¬ì  ì¬í˜„, ì‹¤ì œ ëŸ°íƒ€ì„ ë¯¸í™•ì¸)
- ì¦ê±° ìˆ˜ì§‘: 25/25 (ì™„ì „í•œ ì½”ë“œ ë¶„ì„, ì‹¤í–‰ íë¦„, íƒ€ì´ë° ë‹¤ì´ì–´ê·¸ë¨)
- ì˜í–¥ ë¶„ì„: 20/20 (ëª¨ë“  ì˜í–¥ ë°›ëŠ” ë©”ì„œë“œ ë° ê´€ë ¨ ë²„ê·¸ ì‹ë³„)
- ë¬¸ì„œí™”: 25/25 (í•œê¸€ ì™„ì„±ë„, ë‹¤ì´ì–´ê·¸ë¨, ë¹„êµ ë¶„ì„)
- ê·¼ë³¸ ì›ì¸: 9/10 (5 Whys ì™„ë£Œ, BUG-001ê³¼ íŒ¨í„´ ì¼ì¹˜ í™•ì¸)

### ê°ì  ì´ìœ :
- ì‹¤ì œ ëŸ°íƒ€ì„ ì¬í˜„ í…ŒìŠ¤íŠ¸ ë¯¸ìˆ˜í–‰ (-1ì )

---

**ê²€ì¦ ì™„ë£Œ ì‹œê°**: 2025-11-25 22:37:41 KST
**ê´€ë ¨ ë²„ê·¸**: BUG-20251125-001 (ìœ ì‚¬ íŒ¨í„´)
**ê·¼ë³¸ ì›ì¸**: autoDispose provider + async gap í›„ ref ì ‘ê·¼ + ref.mounted ì²´í¬ ëˆ„ë½
**ë‹¤ìŒ ë‹¨ê³„**: root-cause-analyzerë¥¼ í˜¸ì¶œí•˜ì—¬ ì „ì²´ ë©”ì„œë“œ ìˆ˜ì • ê³„íš ìˆ˜ë¦½
