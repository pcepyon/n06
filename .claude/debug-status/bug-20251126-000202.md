---
status: ANALYZED
timestamp: 2025-11-26T00:03:38+09:00
bug_id: BUG-20251126-000202
verified_by: error-verifier
severity: Critical
---

# ë²„ê·¸ ê²€ì¦ ì™„ë£Œ: PostgrestException - UUID íŒŒì‹± ì—ëŸ¬

## ğŸ” í™˜ê²½ í™•ì¸ ê²°ê³¼

- **Flutter ë²„ì „**: 3.38.1 (stable channel, Dart 3.10.0)
- **ìµœê·¼ ë³€ê²½ì‚¬í•­**: 
  - 9da0715: GridViewë¥¼ Wrapìœ¼ë¡œ ë³€ê²½í•˜ì—¬ intrinsic dimension ì—ëŸ¬ í•´ê²°
  - 7bfaeac: BUG-20251125-233942 í…ŒìŠ¤íŠ¸ ì¶”ê°€
  - 481be98: ëª¨ë“  async mutationì— keepAlive íŒ¨í„´ ì ìš©
- **ì—ëŸ¬ ë¡œê·¸ ë°œê²¬**: ì‚¬ìš©ì ë³´ê³  ê¸°ë°˜

---

## ğŸ› ì¬í˜„ ê²°ê³¼

### ì¬í˜„ ì„±ê³µ ì—¬ë¶€: **ì˜ˆ (ì½”ë“œ ë¶„ì„ ê¸°ë°˜)**

### ì¬í˜„ ë‹¨ê³„:
1. íˆ¬ì—¬ ìŠ¤ì¼€ì¤„ í™”ë©´(`DoseCalendarScreen`)ì—ì„œ íŠ¹ì • ë‚ ì§œ ì„ íƒ
2. "íˆ¬ì—¬ ì™„ë£Œ ê¸°ë¡í•˜ê¸°" ë²„íŠ¼ í´ë¦­ (`SelectedDateDetailCard` Line 251)
3. `DoseRecordDialogV2` ëª¨ë‹¬ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
4. ì£¼ì‚¬ ë¶€ìœ„ ì„ íƒ (ì˜ˆ: ë³µë¶€ ì¢Œì¸¡ìƒë‹¨)
5. "ì €ì¥" ë²„íŠ¼ í´ë¦­ (`_saveDoseRecord` ë©”ì„œë“œ í˜¸ì¶œ)
6. **ì—ëŸ¬ ë°œìƒ**: `PostgrestException(message: invalid input syntax for type uuid: "1764082841952", code: 22P02, details: Bad Request, hint: null)`

### ê´€ì°°ëœ ì—ëŸ¬:
```
PostgrestException(
  message: invalid input syntax for type uuid: "1764082841952", 
  code: 22P02, 
  details: Bad Request, 
  hint: null
)
```

### ì˜ˆìƒ ë™ì‘ vs ì‹¤ì œ ë™ì‘:
- **ì˜ˆìƒ**: íˆ¬ì—¬ ê¸°ë¡ì´ Supabase ë°ì´í„°ë² ì´ìŠ¤ì— ì •ìƒì ìœ¼ë¡œ ì €ì¥ë˜ê³  ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
- **ì‹¤ì œ**: PostgreSQLì´ UUID íƒ€ì… í•„ë“œì— timestamp ë¬¸ìì—´("1764082841952")ì„ íŒŒì‹±í•˜ë ¤ë‹¤ ì‹¤íŒ¨í•˜ì—¬ ì—ëŸ¬ ë°œìƒ

---

## ğŸ“Š ì˜í–¥ë„ í‰ê°€

- **ì‹¬ê°ë„**: **Critical**
  - ì‚¬ìš©ìê°€ íˆ¬ì—¬ ê¸°ë¡ì„ ì €ì¥í•  ìˆ˜ ì—†ëŠ” ì¹˜ëª…ì ì¸ ë²„ê·¸
  - í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ í”Œë¡œìš°(íˆ¬ì—¬ ê¸°ë¡ ì €ì¥) ì™„ì „ ì°¨ë‹¨
  - Phase 1 (Supabase) í™˜ê²½ì—ì„œë§Œ ë°œìƒ (Phase 0 IsarëŠ” ë¬¸ì œ ì—†ìŒ)
  
- **ì˜í–¥ ë²”ìœ„**:
  - `/lib/features/tracking/presentation/dialogs/dose_record_dialog_v2.dart` (Line 171)
  - `/lib/features/tracking/application/notifiers/medication_notifier.dart` (Line 72-120)
  - `/lib/features/tracking/infrastructure/repositories/supabase_medication_repository.dart` (Line 57-60)
  - Supabase ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ: `dose_records` í…Œì´ë¸” (id ì»¬ëŸ¼)
  
- **ì‚¬ìš©ì ì˜í–¥**:
  - Phase 1 í™˜ê²½ì—ì„œ íˆ¬ì—¬ ê¸°ë¡ì„ ì €ì¥í•˜ë ¤ëŠ” ëª¨ë“  ì‚¬ìš©ì
  - íˆ¬ì—¬ ì¤€ìˆ˜ìœ¨ ì¶”ì  ë¶ˆê°€
  - ì£¼ì‚¬ ë¶€ìœ„ ìˆœí™˜ ê¸°ëŠ¥ í™œìš© ë¶ˆê°€
  
- **ë°œìƒ ë¹ˆë„**: **í•­ìƒ** (Phase 1 í™˜ê²½ì—ì„œ íˆ¬ì—¬ ê¸°ë¡ ì €ì¥ ì‹œë„ ì‹œ)

---

## ğŸ“‹ ìˆ˜ì§‘ëœ ì¦ê±°

### ê·¼ë³¸ ì›ì¸ (Root Cause):

**DoseRecord IDë¥¼ timestampë¡œ ìƒì„±í•˜ë‚˜, Supabase ë°ì´í„°ë² ì´ìŠ¤ëŠ” UUID íƒ€ì…ì„ ìš”êµ¬í•¨**

#### ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ:

**íŒŒì¼**: `/lib/features/tracking/presentation/dialogs/dose_record_dialog_v2.dart`
```dart
// Line 170-178
final doseRecord = DoseRecord(
  id: DateTime.now().millisecondsSinceEpoch.toString(),  // â† ë¬¸ì œì˜ ì›ì¸!
  doseScheduleId: widget.schedule.id,
  dosagePlanId: state!.activePlan!.id,
  administeredAt: DateTime.now(),
  actualDoseMg: widget.schedule.scheduledDoseMg,
  injectionSite: selectedSite,
  note: noteController.text.isEmpty ? null : noteController.text,
);
```

**ë¬¸ì œì **:
- `DateTime.now().millisecondsSinceEpoch.toString()`ëŠ” `"1764082841952"` ê°™ì€ ìˆ«ì ë¬¸ìì—´ ìƒì„±
- ì´ ê°’ì€ milliseconds ë‹¨ìœ„ timestamp (ì˜ˆ: 2025-11-26T00:02:21.952Z)
- Supabase ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆì—ì„œ `dose_records.id`ëŠ” **UUID íƒ€ì…**

**ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ**: `/supabase/migrations/01.schema.sql`
```sql
-- Line 96-106
CREATE TABLE public.dose_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),  -- â† UUID íƒ€ì… ìš”êµ¬!
  dose_schedule_id UUID REFERENCES public.dose_schedules(id) ON DELETE SET NULL,
  dosage_plan_id UUID NOT NULL REFERENCES public.dosage_plans(id) ON DELETE CASCADE,
  administered_at TIMESTAMPTZ NOT NULL,
  actual_dose_mg NUMERIC(6,2) NOT NULL,
  injection_site VARCHAR(20),
  is_completed BOOLEAN NOT NULL DEFAULT TRUE,
  note TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### ê¸°ìˆ ì  ë¶„ì„:

1. **Presentation Layer**ì—ì„œ `DoseRecord` ì—”í‹°í‹° ìƒì„± ì‹œ IDë¥¼ timestamp ë¬¸ìì—´ë¡œ ì§€ì •
2. **Application Layer**ì˜ `medicationNotifier.recordDose()` í˜¸ì¶œ
3. **Infrastructure Layer**ì˜ `SupabaseMedicationRepository.saveDoseRecord()` í˜¸ì¶œ
4. `DoseRecordDto.fromEntity(record)`ë¡œ DTO ë³€í™˜
5. `_supabase.from('dose_records').insert(dto.toJson())` ì‹¤í–‰
6. Supabase/PostgreSQLì´ `id` í•„ë“œë¥¼ UUIDë¡œ íŒŒì‹± ì‹œë„
7. **ì—ëŸ¬ ë°œìƒ**: `"1764082841952"`ëŠ” UUID í˜•ì‹ì´ ì•„ë‹˜ (ì˜ˆìƒ: `a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11`)

### ê´€ë ¨ ì½”ë“œ í˜¸ì¶œ ì²´ì¸:

```
DoseRecordDialogV2._saveDoseRecord() (Line 149-203)
  â””â”€ DoseRecord ìƒì„± (id: timestamp string) â† ğŸ’¥ ë¬¸ì œ ë°œìƒ ì§€ì 
      â””â”€ medicationNotifier.recordDose(doseRecord) (Line 181)
          â””â”€ medication_notifier.dart:recordDose() (Line 72-120)
              â””â”€ _repository.saveDoseRecord(record) (Line 103)
                  â””â”€ supabase_medication_repository.dart:saveDoseRecord() (Line 57-60)
                      â””â”€ DoseRecordDto.fromEntity(record)
                          â””â”€ _supabase.from('dose_records').insert(dto.toJson())
                              â””â”€ PostgreSQL UUID parsing â† ğŸ’¥ ì—ëŸ¬!
```

### UUID vs Timestamp ë¹„êµ:

| í•­ëª© | UUID í˜•ì‹ | Timestamp í˜•ì‹ (í˜„ì¬ ì‚¬ìš© ì¤‘) |
|------|-----------|------------------------------|
| ì˜ˆì‹œ | `a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11` | `1764082841952` |
| ê¸¸ì´ | 36ì (í•˜ì´í”ˆ í¬í•¨) | 13ì (ë°€ë¦¬ì´ˆ) |
| í˜•ì‹ | `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` | ìˆ«ì ë¬¸ìì—´ |
| PostgreSQL íƒ€ì… | UUID | BIGINT or TEXT |
| ì¶©ëŒ ê°€ëŠ¥ì„± | ê·¹íˆ ë‚®ìŒ (128-bit) | ë™ì¼ ë°€ë¦¬ì´ˆì— ìƒì„± ì‹œ ì¶©ëŒ |

---

## ğŸ”¬ ì¶”ê°€ ì¦ê±°

### Phase 0 vs Phase 1 ì°¨ì´ì :

**Phase 0 (Isar)**:
- Isar ë°ì´í„°ë² ì´ìŠ¤ëŠ” IDë¥¼ String íƒ€ì…ìœ¼ë¡œ ì €ì¥
- timestamp ë¬¸ìì—´ì„ ê·¸ëŒ€ë¡œ ìˆ˜ìš©
- ì—ëŸ¬ ì—†ì´ ì •ìƒ ì‘ë™

**Phase 1 (Supabase)**:
- PostgreSQLì˜ ì—„ê²©í•œ íƒ€ì… ì‹œìŠ¤í…œ
- UUID íƒ€ì… ì»¬ëŸ¼ì€ UUID í˜•ì‹ë§Œ í—ˆìš©
- timestamp ë¬¸ìì—´ ì…ë ¥ ì‹œ íŒŒì‹± ì—ëŸ¬ ë°œìƒ

### ì—ëŸ¬ ì½”ë“œ ë¶„ì„:

- **PostgreSQL ì—ëŸ¬ ì½”ë“œ 22P02**: "invalid_text_representation"
- **ì˜ë¯¸**: í…ìŠ¤íŠ¸ ì…ë ¥ì´ ë°ì´í„° íƒ€ì… í˜•ì‹ì— ë§ì§€ ì•ŠìŒ
- **ì›ì¸**: UUID íƒ€ì… ì»¬ëŸ¼ì— timestamp ë¬¸ìì—´ ì…ë ¥ ì‹œë„

---

## âœ… Quality Gate 1 ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] ë²„ê·¸ ì¬í˜„ ì„±ê³µ (ì½”ë“œ ë¶„ì„ ê¸°ë°˜)
- [x] ì—ëŸ¬ ë©”ì‹œì§€ ì™„ì „ ìˆ˜ì§‘ (PostgrestException ìƒì„¸ ë¶„ì„)
- [x] ì˜í–¥ ë²”ìœ„ ëª…í™•íˆ ì‹ë³„ (Presentation â†’ Application â†’ Infrastructure)
- [x] ì¦ê±° ì¶©ë¶„íˆ ìˆ˜ì§‘ (ì½”ë“œ, ìŠ¤í‚¤ë§ˆ, ì—ëŸ¬ ì½”ë“œ ë¶„ì„)
- [x] í•œê¸€ ë¬¸ì„œ ì™„ì„±

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

**ê¶Œì¥ ì‚¬í•­**:
1. `root-cause-analyzer` ì—ì´ì „íŠ¸ë¥¼ í˜¸ì¶œí•˜ì—¬ ìˆ˜ì • ë°©ì•ˆ ë„ì¶œ
2. ê°€ëŠ¥í•œ í•´ê²° ë°©ë²•:
   - **Option 1**: Presentation Layerì—ì„œ ID ìƒì„± ì œê±°, Supabaseì˜ `uuid_generate_v4()` í™œìš© (ê¶Œì¥)
   - **Option 2**: `uuid` íŒ¨í‚¤ì§€ë¡œ UUID v4 ìƒì„±
   - **Option 3**: ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆë¥¼ TEXT íƒ€ì…ìœ¼ë¡œ ë³€ê²½ (ê¶Œì¥í•˜ì§€ ì•ŠìŒ)

---

## Next Agent Required
`root-cause-analyzer`

---

## Quality Gate 1 ì ìˆ˜: 95/100

**í‰ê°€ ê¸°ì¤€**:
- ë²„ê·¸ ì¬í˜„: 20/20 (ì½”ë“œ ë¶„ì„ ê¸°ë°˜)
- ì—ëŸ¬ ë©”ì‹œì§€ ìˆ˜ì§‘: 20/20 (PostgrestException ìƒì„¸ ë¶„ì„)
- ì˜í–¥ ë²”ìœ„ ì‹ë³„: 20/20 (Presentation â†’ Infrastructure ì¶”ì )
- ì¦ê±° ìˆ˜ì§‘: 20/20 (ì½”ë“œ, ìŠ¤í‚¤ë§ˆ, Phase ì°¨ì´ ë¶„ì„)
- í•œê¸€ ë¬¸ì„œí™”: 15/20 (í”„ë¡œë•ì…˜ ì¬í˜„ ëŒ€ê¸° ì¤‘)

---

---

## Stage 2: Root Cause Analysis

**ë¶„ì„ ì‹œê°**: 2025-11-26T00:10:00+09:00
**ë¶„ì„ì**: root-cause-analyzer (Claude Opus 4.5)
**í™•ì‹ ë„**: 95%

---

## 1. ê²€ì¦ ë¦¬í¬íŠ¸ í™•ì¸

- **ë²„ê·¸ ID**: BUG-20251126-000202
- **ê²€ì¦ ì™„ë£Œ ì‹œê°**: 2025-11-26T00:03:38+09:00
- **ì‹¬ê°ë„**: Critical
- **ìƒíƒœ**: VERIFIED â†’ ANALYZED

---

## 2. ì›ì¸ ê°€ì„¤ë“¤

### ê°€ì„¤ 1 (ìµœìœ ë ¥): Presentation Layerì—ì„œ timestampë¡œ ID ìƒì„±
**ì„¤ëª…**: `DoseRecordDialogV2`ì—ì„œ DoseRecord ìƒì„± ì‹œ `DateTime.now().millisecondsSinceEpoch.toString()`ìœ¼ë¡œ IDë¥¼ ìƒì„±í•˜ë‚˜, Supabase ìŠ¤í‚¤ë§ˆì—ì„œëŠ” UUID íƒ€ì…ì„ ìš”êµ¬í•¨
**ê·¼ê±°**: 
- `dose_record_dialog_v2.dart:171`ì—ì„œ timestamp ë¬¸ìì—´ ìƒì„± í™•ì¸
- `01.schema.sql:97`ì—ì„œ `id UUID PRIMARY KEY` íƒ€ì… ì •ì˜ í™•ì¸
- PostgreSQL ì—ëŸ¬ ì½”ë“œ 22P02 (invalid_text_representation)
**í™•ë¥ **: High (95%)

### ê°€ì„¤ 2: DTO ë³€í™˜ ê³¼ì •ì—ì„œ ID íƒ€ì… ë¶ˆì¼ì¹˜
**ì„¤ëª…**: DoseRecordDtoì—ì„œ JSON ë³€í™˜ ì‹œ UUID í˜•ì‹ ê²€ì¦ì´ ì—†ì–´ ì˜ëª»ëœ í˜•ì‹ì´ ê·¸ëŒ€ë¡œ ì „ë‹¬ë¨
**ê·¼ê±°**: DTOëŠ” ë‹¨ìˆœ ë³€í™˜ë§Œ ìˆ˜í–‰í•˜ê³  íƒ€ì… ê²€ì¦ì´ ì—†ìŒ
**í™•ë¥ **: Medium (ë¶€ì°¨ì  ì›ì¸)

### ê°€ì„¤ 3: Repository Layerì—ì„œ ì„œë²„ ê¸°ë³¸ê°’ ë¯¸í™œìš©
**ì„¤ëª…**: Supabase ìŠ¤í‚¤ë§ˆì—ì„œ `DEFAULT uuid_generate_v4()`ê°€ ìˆìœ¼ë‚˜, í´ë¼ì´ì–¸íŠ¸ì—ì„œ IDë¥¼ ì „ë‹¬í•˜ì—¬ ê¸°ë³¸ê°’ì´ ë¬´ì‹œë¨
**ê·¼ê±°**: `01.schema.sql:97`ì—ì„œ DEFAULT ì ˆ í™•ì¸
**í™•ë¥ **: Medium (ì„¤ê³„ ë¬¸ì œ)

---

## 3. ì½”ë“œ ì‹¤í–‰ ê²½ë¡œ ì¶”ì 

### ì§„ì…ì 
`/lib/features/tracking/presentation/dialogs/dose_record_dialog_v2.dart:149`
```dart
Future<void> _saveDoseRecord() async {
```

### í˜¸ì¶œ ì²´ì¸
1. `DoseRecordDialogV2._saveDoseRecord()` (Line 149)
2. `DoseRecord` ìƒì„± (Line 170-178) - **ë¬¸ì œ ë°œìƒ ì§€ì **
3. `medicationNotifier.recordDose(doseRecord)` (Line 181)
4. `SupabaseMedicationRepository.saveDoseRecord(record)` (Line 57)
5. `DoseRecordDto.fromEntity(record)` (Line 58)
6. `_supabase.from('dose_records').insert(dto.toJson())` (Line 59)
7. PostgreSQL UUID íŒŒì‹± ì‹œë„ - **ì—ëŸ¬ ë°œìƒ**

### ìƒíƒœ ë³€í™” ì¶”ì 
| ë‹¨ê³„ | ë³€ìˆ˜/ìƒíƒœ | ì‹¤ì œ ê°’ | ì˜ˆìƒê°’ | ì¼ì¹˜ ì—¬ë¶€ |
|------|-----------|---------|--------|-----------|
| 1 | `selectedSite` | "abdomen_upper_left" | valid string | O |
| 2 | `doseRecord.id` | "1764082841952" | UUID format | X |
| 3 | `dto.toJson()['id']` | "1764082841952" | UUID format | X |
| 4 | PostgreSQL parsing | FAIL | UUID | X |

### ì‹¤íŒ¨ ì§€ì  ì½”ë“œ
`/lib/features/tracking/presentation/dialogs/dose_record_dialog_v2.dart:170-178`
```dart
final doseRecord = DoseRecord(
  id: DateTime.now().millisecondsSinceEpoch.toString(),  // <-- ë¬¸ì œ ì›ì¸
  doseScheduleId: widget.schedule.id,
  dosagePlanId: state!.activePlan!.id,
  administeredAt: DateTime.now(),
  actualDoseMg: widget.schedule.scheduledDoseMg,
  injectionSite: selectedSite,
  note: noteController.text.isEmpty ? null : noteController.text,
);
```
**ë¬¸ì œ**: timestamp ë¬¸ìì—´ "1764082841952"ëŠ” UUID í˜•ì‹ "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"ê°€ ì•„ë‹˜

---

## 4. 5 Whys ê·¼ë³¸ ì›ì¸ ë¶„ì„

**ë¬¸ì œ ì¦ìƒ**: PostgrestException - invalid input syntax for type uuid: "1764082841952"

1. **ì™œ ì´ ì—ëŸ¬ê°€ ë°œìƒí–ˆëŠ”ê°€?**
   â†’ PostgreSQLì´ timestamp ë¬¸ìì—´ì„ UUIDë¡œ íŒŒì‹±í•˜ë ¤ í–ˆìœ¼ë‚˜ í˜•ì‹ì´ ë§ì§€ ì•Šì•„ ì‹¤íŒ¨

2. **ì™œ timestamp ë¬¸ìì—´ì´ UUID ì»¬ëŸ¼ì— ì „ë‹¬ë˜ì—ˆëŠ”ê°€?**
   â†’ DoseRecord ì—”í‹°í‹° ìƒì„± ì‹œ IDë¥¼ `DateTime.now().millisecondsSinceEpoch.toString()`ìœ¼ë¡œ ìƒì„±í–ˆê¸° ë•Œë¬¸

3. **ì™œ Presentation Layerì—ì„œ IDë¥¼ ì´ëŸ° ë°©ì‹ìœ¼ë¡œ ìƒì„±í–ˆëŠ”ê°€?**
   â†’ Phase 0 (Isar) í™˜ê²½ì—ì„œëŠ” String IDê°€ í—ˆìš©ë˜ì–´ ë¬¸ì œê°€ ì—†ì—ˆê³ , Phase 1 (Supabase) ì „í™˜ ì‹œ ID ìƒì„± ë°©ì‹ì´ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ

4. **ì™œ Phase ì „í™˜ ì‹œ ì´ ì½”ë“œê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ëŠ”ê°€?**
   â†’ í”„ë¡œì íŠ¸ ë‚´ ë‹¤ë¥¸ íŒŒì¼ë“¤(`dose_record_edit_notifier.dart`, `daily_tracking_screen.dart` ë“±)ì€ ì´ë¯¸ `const Uuid().v4()`ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë‚˜, `dose_record_dialog_v2.dart`ëŠ” ë ˆê±°ì‹œ íŒ¨í„´ì´ ë‚¨ì•„ìˆì—ˆìŒ

5. **ì™œ ë ˆê±°ì‹œ íŒ¨í„´ì´ ë‚¨ì•„ìˆì—ˆëŠ”ê°€?**
   â†’ **ê·¼ë³¸ ì›ì¸: ID ìƒì„± íŒ¨í„´ í‘œì¤€í™” ë¶€ì¬** - í”„ë¡œì íŠ¸ ì „ì²´ì—ì„œ ì¼ê´€ëœ ID ìƒì„± ì •ì±…ì´ ë¬¸ì„œí™”ë˜ì§€ ì•Šì•„, ìƒˆë¡œìš´ ì½”ë“œ ì‘ì„± ë˜ëŠ” ë¦¬íŒ©í† ë§ ì‹œ ì˜¬ë°”ë¥¸ íŒ¨í„´ ì ìš©ì´ ëˆ„ë½ë¨

---

## 5. ì˜ì¡´ì„± ë° ê¸°ì—¬ ìš”ì¸ ë¶„ì„

### ì™¸ë¶€ ì˜ì¡´ì„±
- **Supabase PostgreSQL**: UUID íƒ€ì…ì˜ ì—„ê²©í•œ í˜•ì‹ ê²€ì¦
- **uuid íŒ¨í‚¤ì§€** (v4.0.0): ì´ë¯¸ í”„ë¡œì íŠ¸ì— ì¡´ì¬í•˜ì§€ë§Œ í•´ë‹¹ íŒŒì¼ì—ì„œ ë¯¸ì‚¬ìš©

### ìƒíƒœ ì˜ì¡´ì„±
- `widget.schedule.id`: UUID í˜•ì‹ (ì •ìƒ)
- `state.activePlan!.id`: UUID í˜•ì‹ (ì •ìƒ)
- `selectedSite`: String (ì •ìƒ)

### íƒ€ì´ë°/ë™ì‹œì„± ë¬¸ì œ
í•´ë‹¹ ì—†ìŒ

### ë°ì´í„° ì˜ì¡´ì„±
- `DoseRecord.id` â†’ `dose_records.id` (UUID íƒ€ì…) - **íƒ€ì… ë¶ˆì¼ì¹˜**

### ì„¤ì • ì˜ì¡´ì„±
- Phase 0 (Isar): String ID í—ˆìš© - ë¬¸ì œ ì—†ìŒ
- Phase 1 (Supabase): UUID íƒ€ì… ìš”êµ¬ - **ì—ëŸ¬ ë°œìƒ**

---

## 6. ë™ì¼ íŒ¨í„´ ì „ì²´ íƒìƒ‰ ê²°ê³¼

### millisecondsSinceEpochë¥¼ IDë¡œ ì‚¬ìš©í•˜ëŠ” ê³³

| íŒŒì¼ | ë¼ì¸ | íŒ¨í„´ | Supabase í…Œì´ë¸” | ì»¬ëŸ¼ íƒ€ì… | ë¬¸ì œ ì—¬ë¶€ |
|------|------|------|-----------------|-----------|-----------|
| `dose_record_dialog_v2.dart` | 171 | `DateTime.now().millisecondsSinceEpoch.toString()` | `dose_records` | UUID | **Critical** |
| `supabase_medication_repository.dart` | 237 | `'history_${DateTime.now().millisecondsSinceEpoch}'` | `plan_change_history` | UUID | **Critical** |
| `supabase_auth_repository.dart` | 338 | `'naver_${naverAccount.id ?? DateTime.now().millisecondsSinceEpoch}'` | `users` | TEXT | OK (TEXT íƒ€ì…) |

### UUID íŒ¨í‚¤ì§€ê°€ ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš©ë˜ëŠ” ê³³ (ì°¸ê³ )

| íŒŒì¼ | ë¼ì¸ | ìš©ë„ |
|------|------|------|
| `onboarding_notifier.dart` | 67, 95 | DosagePlan, DoseSchedule ID ìƒì„± |
| `generate_dose_schedules_usecase.dart` | 42 | DoseSchedule ID ìƒì„± |
| `daily_tracking_screen.dart` | 201, 216 | WeightLog, SymptomLog ID ìƒì„± |
| `dose_record_edit_notifier.dart` | 55, 110 | AuditLog ID ìƒì„± |
| `weight_record_edit_notifier.dart` | 75, 97, 146 | WeightLog, AuditLog ID ìƒì„± |
| `symptom_record_edit_notifier.dart` | 55, 112 | SymptomLog, AuditLog ID ìƒì„± |
| `emergency_check_notifier.dart` | 80 | EmergencySymptomCheck ID ìƒì„± |
| `emergency_check_screen.dart` | 86 | EmergencySymptomCheck ID ìƒì„± |
| `recalculate_dose_schedule_usecase.dart` | 35 | DoseSchedule ID ìƒì„± |

---

## 7. Supabase ìŠ¤í‚¤ë§ˆ ëŒ€ì¡° ë¶„ì„

### UUID íƒ€ì…ì„ ìš”êµ¬í•˜ëŠ” í…Œì´ë¸” (ë¬¸ì œ ì˜ì—­)

| í…Œì´ë¸” | ID ì»¬ëŸ¼ íƒ€ì… | ê¸°ë³¸ê°’ | ë¬¸ì œê°€ ë˜ëŠ” ì½”ë“œ |
|--------|--------------|--------|------------------|
| `dose_records` | UUID | `uuid_generate_v4()` | `dose_record_dialog_v2.dart:171` |
| `plan_change_history` | UUID | `uuid_generate_v4()` | `supabase_medication_repository.dart:237` |
| `dose_schedules` | UUID | `uuid_generate_v4()` | N/A (ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬ë¨) |
| `dosage_plans` | UUID | `uuid_generate_v4()` | N/A (ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬ë¨) |

### TEXT íƒ€ì…ì„ ì‚¬ìš©í•˜ëŠ” í…Œì´ë¸” (ì•ˆì „)

| í…Œì´ë¸” | ID ì»¬ëŸ¼ íƒ€ì… | ë¬¸ì œ ì—¬ë¶€ |
|--------|--------------|-----------|
| `users` | TEXT | ì•ˆì „ (Naver ì ‘ë‘ì‚¬ í—ˆìš©) |

---

## 8. ì˜í–¥ ë²”ìœ„ ë° ë¶€ì‘ìš© ë¶„ì„

### ì§ì ‘ì  ì˜í–¥
- **`dose_record_dialog_v2.dart:171`**: íˆ¬ì—¬ ê¸°ë¡ ì €ì¥ ì™„ì „ ì°¨ë‹¨
- **`supabase_medication_repository.dart:237`**: ê³„íš ë³€ê²½ ì´ë ¥ ì €ì¥ ì‹¤íŒ¨ (ì ì¬ì )

### ê°„ì ‘ì  ì˜í–¥
- íˆ¬ì—¬ ê¸°ë¡ ì—†ì´ íˆ¬ì—¬ ì¤€ìˆ˜ìœ¨ ê³„ì‚° ë¶ˆê°€
- ì£¼ì‚¬ ë¶€ìœ„ ìˆœí™˜ ì¶”ì²œ ê¸°ëŠ¥ ì‘ë™ ë¶ˆê°€
- ëŒ€ì‹œë³´ë“œ í†µê³„ì— íˆ¬ì—¬ ê¸°ë¡ ë¯¸ë°˜ì˜

### ìˆ˜ì • ì‹œ ì£¼ì˜ì‚¬í•­
- ê¸°ì¡´ Isar ë°ì´í„°ì™€ì˜ í˜¸í™˜ì„± ê³ ë ¤ í•„ìš” (ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ)
- ID ìƒì„± ìœ„ì¹˜ê°€ Presentation Layerì¸ ì ì€ ì•„í‚¤í…ì²˜ ê°œì„  ëŒ€ìƒ

### ì˜í–¥ ë°›ì„ ìˆ˜ ìˆëŠ” ê´€ë ¨ ì˜ì—­
- `deleteDoseRecord`: recordIdë¡œ ì‚­ì œ ì‹œ ID í˜•ì‹ ì¼ê´€ì„± í•„ìš”
- `updateDoseRecord`: recordIdë¡œ ì—…ë°ì´íŠ¸ ì‹œ ID í˜•ì‹ ì¼ê´€ì„± í•„ìš”
- FK ê´€ê³„: `dose_schedule_id`, `dosage_plan_id`ëŠ” ì´ë¯¸ UUIDë¡œ ì „ë‹¬ë¨ (ì •ìƒ)

---

## 9. ê·¼ë³¸ ì›ì¸ í™•ì •

### ìµœì¢… ê·¼ë³¸ ì›ì¸
**í”„ë¡œì íŠ¸ ë‚´ ID ìƒì„± íŒ¨í„´ í‘œì¤€í™” ë¶€ì¬ë¡œ ì¸í•´ Phase 1 (Supabase) ì „í™˜ ì‹œ ì¼ë¶€ ì½”ë“œê°€ ë ˆê±°ì‹œ timestamp íŒ¨í„´ì„ ìœ ì§€í•˜ì—¬ UUID íƒ€ì… ë¶ˆì¼ì¹˜ ë°œìƒ**

### ì¦ê±° ê¸°ë°˜ ê²€ì¦
1. **ì¦ê±° 1**: `dose_record_dialog_v2.dart:171`ì—ì„œ `millisecondsSinceEpoch` ì‚¬ìš© í™•ì¸
2. **ì¦ê±° 2**: `01.schema.sql:97`ì—ì„œ `dose_records.id`ê°€ UUID íƒ€ì…ì„ í™•ì¸
3. **ì¦ê±° 3**: ë™ì¼ í”„ë¡œì íŠ¸ ë‚´ ë‹¤ë¥¸ 9ê°œ íŒŒì¼ì—ì„œ `const Uuid().v4()` ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš© ì¤‘
4. **ì¦ê±° 4**: `supabase_medication_repository.dart:237`ì—ì„œ ë™ì¼í•œ ë ˆê±°ì‹œ íŒ¨í„´ ë°œê²¬

### ì¸ê³¼ ê´€ê³„ ì²´ì¸
```
[í‘œì¤€í™” ë¶€ì¬] â†’ [ë ˆê±°ì‹œ ì½”ë“œ ë¯¸ì—…ë°ì´íŠ¸] â†’ [timestamp ID ìƒì„±] â†’ [UUID íƒ€ì… ë¶ˆì¼ì¹˜] â†’ [PostgrestException]
```

### í™•ì‹ ë„: 95%

### ì œì™¸ëœ ê°€ì„¤ë“¤
- **DTO ë³€í™˜ ë¬¸ì œ**: DTOëŠ” ë‹¨ìˆœ ë³€í™˜ë§Œ ìˆ˜í–‰í•˜ë©°, ê·¼ë³¸ ì›ì¸ì€ ID ìƒì„± ì‹œì ì„
- **ì„œë²„ ê¸°ë³¸ê°’ ë¬¸ì œ**: í´ë¼ì´ì–¸íŠ¸ì—ì„œ IDë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬í•˜ë¯€ë¡œ ê¸°ë³¸ê°’ì´ ë¬´ì‹œë˜ëŠ” ê²ƒì€ ì •ìƒ ë™ì‘

---

## 10. ìˆ˜ì • ì „ëµ ê¶Œì¥ì‚¬í•­

### ìµœì†Œ ìˆ˜ì • ë°©ì•ˆ
**ì ‘ê·¼**: ë¬¸ì œê°€ ë˜ëŠ” 2ê°œ íŒŒì¼ë§Œ `const Uuid().v4()`ë¡œ ë³€ê²½
**ì¥ì **: ì¦‰ì‹œ ì ìš© ê°€ëŠ¥, ìµœì†Œ ë¦¬ìŠ¤í¬
**ë‹¨ì **: ê·¼ë³¸ì ì¸ í‘œì¤€í™” ë¬¸ì œ ë¯¸í•´ê²°
**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 30ë¶„

**ìˆ˜ì • í•„ìš” íŒŒì¼ ë° ë¼ì¸**:
1. `/lib/features/tracking/presentation/dialogs/dose_record_dialog_v2.dart:171`
   - ë³€ê²½ ì „: `id: DateTime.now().millisecondsSinceEpoch.toString(),`
   - ë³€ê²½ í›„: `id: const Uuid().v4(),`
   - ì¶”ê°€: `import 'package:uuid/uuid.dart';`

2. `/lib/features/tracking/infrastructure/repositories/supabase_medication_repository.dart:237`
   - ë³€ê²½ ì „: `id: 'history_${DateTime.now().millisecondsSinceEpoch}',`
   - ë³€ê²½ í›„: `id: const Uuid().v4(),`
   - ì¶”ê°€: `import 'package:uuid/uuid.dart';`

### í¬ê´„ì  ìˆ˜ì • ë°©ì•ˆ
**ì ‘ê·¼**: ID ìƒì„± í—¬í¼ í•¨ìˆ˜ ë˜ëŠ” íŒ©í† ë¦¬ íŒ¨í„´ ë„ì…í•˜ì—¬ í”„ë¡œì íŠ¸ ì „ì²´ í‘œì¤€í™”
**ì¥ì **: í–¥í›„ ìœ ì‚¬ ë¬¸ì œ ë°©ì§€, ì¼ê´€ì„± í™•ë³´
**ë‹¨ì **: ë¦¬íŒ©í† ë§ ë²”ìœ„ê°€ ë„“ìŒ
**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 2-4ì‹œê°„

### ê¶Œì¥ ë°©ì•ˆ: ìµœì†Œ ìˆ˜ì • ë°©ì•ˆ ìš°ì„  ì ìš©
**ì´ìœ **: Critical ë²„ê·¸ì´ë¯€ë¡œ ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•˜ë©°, í‘œì¤€í™”ëŠ” í›„ì† ì‘ì—…ìœ¼ë¡œ ì§„í–‰

### ì¬ë°œ ë°©ì§€ ì „ëµ
1. **CLAUDE.mdì— ID ìƒì„± ê·œì¹™ ì¶”ê°€**: "ëª¨ë“  ì—”í‹°í‹° IDëŠ” `const Uuid().v4()`ë¡œ ìƒì„±"
2. **ì½”ë“œ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸ ì¶”ê°€**: "millisecondsSinceEpochë¥¼ IDë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸"
3. **Lint ê·œì¹™ ê³ ë ¤**: Custom lintë¡œ timestamp ID íŒ¨í„´ ê°ì§€ (ì¥ê¸°)

### í…ŒìŠ¤íŠ¸ ì „ëµ
- **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**: DoseRecord IDê°€ UUID í˜•ì‹ì¸ì§€ ê²€ì¦
- **í†µí•© í…ŒìŠ¤íŠ¸**: Supabaseì— DoseRecord ì €ì¥ ì„±ê³µ í™•ì¸
- **íšŒê·€ í…ŒìŠ¤íŠ¸**: ê¸°ì¡´ íˆ¬ì—¬ ê¸°ë¡ ì¡°íšŒ/ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥ ì •ìƒ ë™ì‘ í™•ì¸

---

## 11. Quality Gate 2 ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] ê·¼ë³¸ ì›ì¸ ëª…í™•íˆ ì‹ë³„
- [x] 5 Whys ë¶„ì„ ì™„ë£Œ
- [x] ëª¨ë“  ê¸°ì—¬ ìš”ì¸ ë¬¸ì„œí™”
- [x] ìˆ˜ì • ì „ëµ ì œì‹œ
- [x] í™•ì‹ ë„ 90% ì´ìƒ (95%)
- [x] í•œê¸€ ë¬¸ì„œ ì™„ì„±

---

## Next Agent Required
`fix-validator`

---

**Quality Gate 2 ì ìˆ˜: 95/100**

**í‰ê°€ ê¸°ì¤€**:
- ê·¼ë³¸ ì›ì¸ ì‹ë³„: 25/25 (ëª…í™•í•œ ì¸ê³¼ê´€ê³„ ì¶”ì )
- 5 Whys ë¶„ì„: 20/20 (í‘œì¤€í™” ë¶€ì¬ê¹Œì§€ ë„ë‹¬)
- ë™ì¼ íŒ¨í„´ íƒìƒ‰: 20/20 (í”„ë¡œì íŠ¸ ì „ì²´ ê²€ìƒ‰ ì™„ë£Œ)
- ì˜í–¥ ë²”ìœ„ ë¶„ì„: 15/15 (ì§ì ‘/ê°„ì ‘ ì˜í–¥ ëª…ì‹œ)
- ìˆ˜ì • ì „ëµ: 15/20 (ìµœì†Œ ìˆ˜ì •ì•ˆ ìƒì„¸, í¬ê´„ ìˆ˜ì •ì•ˆ ê°œìš”)

