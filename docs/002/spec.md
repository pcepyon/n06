# UF-F000: 온보딩 및 목표 설정 - 상세 유스케이스

## Primary Actor
소셜 로그인(F-001)을 완료하고 치료 프로필 및 목표를 설정해야 하는 신규 사용자

## Precondition
- 사용자가 소셜 로그인을 성공적으로 완료함
- 사용자가 이용약관 및 개인정보처리방침에 동의함
- 사용자가 앱을 처음 실행함(온보딩 미완료 상태)

## Trigger
사용자가 최초 소셜 로그인 인증을 완료하면 자동으로 온보딩 화면으로 이동

## Main Scenario

### 단계 1: 기본 프로필 설정
1. 시스템이 진행 표시기와 함께 온보딩 환영 화면을 표시
2. 사용자가 이름 입력 필드에 이름 입력
3. 시스템이 이름이 비어있지 않은지 검증
4. 사용자가 다음 단계로 진행

### 단계 2: 체중 및 목표 입력
1. 시스템이 체중 및 목표 입력 화면 표시
2. 사용자가 현재 체중(kg) 입력
3. 사용자가 목표 체중(kg) 입력
4. 사용자가 목표 기간(주 단위) 입력(선택 사항)
5. 시스템이 다음 항목 검증:
   - 현재 체중이 양수이며 현실적인 범위(20-300kg) 내에 있는지
   - 목표 체중이 양수이며 현실적인 범위(20-300kg) 내에 있는지
   - 목표 체중이 현재 체중보다 작은지
   - 목표 기간이 입력된 경우 양수인지
6. 목표 기간이 입력된 경우, 시스템이 주간 감량 목표 자동 계산:
   - 계산식: (현재 체중 - 목표 체중) / 목표 기간
7. 시스템이 계산된 주간 감량 목표 표시
8. 주간 감량 목표가 안전 기준(주당 1kg)을 초과하는 경우, 시스템이 경고 메시지 표시하되 진행 허용
9. 사용자가 다음 단계로 진행

### 단계 3: 투여 계획 설정
1. 시스템이 투여 계획 입력 화면 표시
2. 사용자가 약물명 입력
3. 사용자가 캘린더 피커를 통해 시작일 선택
4. 사용자가 투여 주기(일 단위) 입력
5. 사용자가 초기 용량(mg) 입력
6. 사용자가 증량 계획 입력:
   - 각 증량 단계마다 다음 항목 지정:
     - 목표 용량(mg)
     - 시작 시점(시작일로부터 주 단위)
7. 시스템이 다음 항목 검증:
   - 약물명이 비어있지 않은지
   - 시작일이 현재 또는 미래 날짜인지
   - 투여 주기가 양의 정수인지
   - 초기 용량이 양수인지
   - 증량 계획이 논리적 순서를 따르는지(용량 증가, 기간 순차적)
8. 사용자가 최종 단계로 진행

### 단계 4: 확인 및 완료
1. 시스템이 입력된 정보 요약 표시:
   - 이름
   - 현재 체중 및 목표 체중
   - 주간 감량 목표(해당하는 경우)
   - 투여 계획 세부 정보
2. 사용자가 정보를 검토하고 확인
3. 시스템이 Repository 패턴을 통해 모든 데이터 저장:
   - 사용자 프로필(이름, 생성일시)
   - 사용자 목표(목표 체중, 목표 기간, 주간 감량 목표)
   - 투여 계획(약물명, 시작일, 주기, 초기 용량, 증량 계획)
   - 현재 체중과 오늘 날짜로 초기 체중 기록 생성
4. 시스템이 투여 스케줄 생성 트리거(F001 연동)
5. 시스템이 완료 메시지 표시
6. 시스템이 홈 대시보드(F006)로 이동

## Edge Cases

### 입력 오류
- **이름이 비어있는 경우**: 에러 메시지 표시, 진행 차단
- **목표 체중이 현재 체중보다 큰 경우**: 에러 메시지 표시, 진행 차단
- **비현실적인 체중 값(<20kg 또는 >300kg)**: 확인 다이얼로그 표시
- **과도한 주간 감량 목표(주당 1kg 초과)**: 경고 메시지 표시, 확인 후 진행 허용

### 날짜 및 기간 문제
- **시작일이 과거인 경우**: 현재 날짜로 조정 제안, 사용자가 재정의 가능
- **목표 기간 미입력**: 주간 감량 목표 계산 건너뛰기, 진행 허용

### 증량 계획 문제
- **용량이 감소하는 경우**: 에러 메시지 표시, 진행 차단
- **중복 시기**: 에러 메시지 표시, 수정 요청
- **증량 계획 미입력**: 초기 용량만으로 진행 허용

### 세션 중단
- **온보딩 중 앱 종료**: 데이터가 저장되지 않음, 다음 실행 시 온보딩 재시작
- **저장 중 네트워크 오류**: 에러 메시지 표시, 재시도 허용

### 데이터 저장
- **저장 작업 실패**: 에러 메시지 표시, 재시도 또는 취소 허용
- **일부 데이터만 저장**: 트랜잭션을 구현하여 전체 저장 또는 저장 없음을 보장

## Business Rules

### BR-1: 체중 검증
- 현재 체중과 목표 체중은 20-300kg 범위 내여야 함
- 목표 체중은 현재 체중보다 작아야 함
- 주간 감량 목표가 1kg/주를 초과하는 경우 경고하되 진행 허용

### BR-2: 투여 계획 요구사항
- 약물명은 필수
- 시작일은 과거 7일 이내여야 함
- 투여 주기는 양의 정수여야 함(GLP-1의 경우 일반적으로 7일)
- 초기 용량은 양수여야 함
- 증량 계획은 점진적 용량 증가를 보여야 함

### BR-3: 데이터 무결성
- 모든 온보딩 데이터는 원자적으로 저장되어야 함(전체 저장 또는 저장 없음)
- 현재 체중으로 초기 체중 기록이 자동 생성됨
- 온보딩 완료 후 투여 스케줄이 자동 생성됨

### BR-4: 목표 계산
- 주간 감량 목표는 목표 기간이 입력된 경우에만 계산됨
- 계산식: (현재 체중 - 목표 체중) / 목표 기간
- 주간 목표는 저장되지만 설정에서 수정 가능

### BR-5: 사용자 경험
- 최초 로그인 후 모든 신규 사용자에게 온보딩 필수
- 온보딩은 한 번만 완료 가능
- 모든 온보딩 데이터는 설정(F000)을 통해 수정 가능
- 진행 표시기가 온보딩 흐름에서 사용자의 위치를 표시

### BR-6: 주간 기록 목표
- 기본 주간 체중 기록 목표: 주당 7회
- 기본 주간 증상 기록 목표: 주당 7회
- 이러한 기본값은 온보딩 중 적용되지만 설정(UF-013)에서 조정 가능

## Sequence Diagram

```plantuml
@startuml
actor User
participant FE
participant BE
participant Database

User -> FE: 소셜 로그인 완료(F-001)
FE -> BE: 온보딩 상태 확인
BE -> Database: user_profiles 조회
Database --> BE: 프로필 없음
BE --> FE: 온보딩 화면으로 리디렉션

FE -> User: 환영 화면 표시

User -> FE: 이름 입력
FE -> FE: 이름이 비어있지 않은지 검증
FE -> User: 다음 버튼 활성화

User -> FE: 다음 클릭
FE -> User: 체중 및 목표 화면 표시

User -> FE: 현재 체중 입력
User -> FE: 목표 체중 입력
User -> FE: 목표 기간 입력(선택)
FE -> BE: 체중 입력 검증
BE --> FE: 검증 결과
FE -> BE: 주간 감량 목표 계산(기간 입력 시)
BE --> FE: 주간 감량 목표
FE -> User: 계산된 목표 표시
alt 주간 감량 목표 > 1kg/주
    FE -> User: 안전 경고 표시
end
FE -> User: 다음 버튼 활성화

User -> FE: 다음 클릭
FE -> User: 투여 계획 화면 표시

User -> FE: 약물명 입력
User -> FE: 시작일 선택
User -> FE: 투여 주기 입력
User -> FE: 초기 용량 입력
User -> FE: 증량 계획 입력
FE -> BE: 투여 계획 검증
BE --> FE: 검증 결과
alt 시작일이 과거인 경우
    FE -> User: 현재 날짜 조정 제안
end
FE -> User: 다음 버튼 활성화

User -> FE: 다음 클릭
FE -> User: 요약 화면 표시

User -> FE: 정보 확인
FE -> BE: 온보딩 데이터 저장
BE -> Database: 트랜잭션 시작
BE -> Database: users 업데이트(필요 시 이름 갱신)
BE -> Database: user_profiles 삽입
BE -> Database: dosage_plans 삽입
BE -> Database: weight_logs 삽입(초기 기록)
Database --> BE: 저장 성공
BE -> Database: 트랜잭션 커밋
BE -> BE: 투여 스케줄 생성 트리거
BE -> Database: dose_schedules 삽입
Database --> BE: 스케줄 생성 완료
BE --> FE: 온보딩 완료

FE -> User: 성공 메시지 표시
FE -> User: 홈 대시보드(F006)로 이동

alt 저장 실패
    Database --> BE: 에러
    BE -> Database: 트랜잭션 롤백
    BE --> FE: 에러 메시지
    FE -> User: 에러 표시, 재시도 제안
end
@enduml
```
